server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;

  include snippets/{{ membres_ssl_snippet_conf }};

  server_name {{ membres_server_fqdn }};

  root /var/www/ledetour-membres/src;
  index index.html;

  location / {
    try_files $uri $uri/ =404;
  }
}


server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;

  include snippets/snakeoil.conf;

  server_name membres.*;

  root /var/www/ledetour-membres/src;
  index index.html;

  location /data.txt {
    set $ssl_client_verify "SUCCESS";

    if ($ssl_client_verify = "SUCCESS") {
      rewrite ^/data.txt$ /secret.txt last;
    }
    rewrite ^/data.txt$ /notsecret.txt last;
  }

  location /secret.txt {
    if ($ssl_client_verify != "SUCCESS") {
      return 403;
    }
    alias /var/www/ledetour-membres/secret.txt;
  }

  location /notsecret.txt {
    alias /var/www/ledetour-membres/notsecret.txt;
  }

  location / {
    try_files $uri $uri/ =404;
  }
}